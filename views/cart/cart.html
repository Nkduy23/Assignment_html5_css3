<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ Hàng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="../../assets/css/main.css" />
    <link rel="stylesheet" href="../../assets/css/cart.css" />
  </head>
  <body>
    <div id="header-placeholder"></div>

    <div class="container-main">
      <main class="cart-container">
        <h2>Giỏ Hàng</h2>

        <div class="cart-content">
          <!-- Bảng sản phẩm -->
          <table class="cart-table">
            <thead>
              <tr>
                <th>STT</th>
                <th>Tên sản phẩm</th>
                <th>Hình ảnh</th>
                <th>Giá</th>
                <th>Màu sắc</th>
                <th>Size</th>
                <th>Số lượng</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="cart-items">
              <!-- Dữ liệu sẽ được thêm từ JS -->
            </tbody>
          </table>
        </div>
      </main>

      <!-- Bảng tổng tiền -->
      <div class="cart-summary-container">
        <div class="cart-summary">
          <h3>Tổng tiền</h3>
          <p><strong>Tổng cộng:</strong> <span id="total-price">0</span> đ</p>
          <button class="checkout-btn">Thanh toán</button>
        </div>
      </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="../../assets/js/product-detail-main.js" type="module"></script>

    <script>
      window.renderCart = function () {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const cartArea = document.getElementById("cart-items");
        const totalPriceEl = document.getElementById("total-price");

        cartArea.innerHTML = "";
        let totalPrice = 0;

        cart.forEach((item, index) => {
          const cartItem = document.createElement("tr");
          const cleanPrice = parseFloat(item.price.replace(/[^0-9]/g, "")) || 0;

          cartItem.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.name}</td>
      <td><img src="${item.image}" alt="${item.name}" width="50"></td>
      <td>${cleanPrice.toLocaleString()} đ</td>
      <td>${item.color}</td>
      <td>
        <select class="cart-size" data-id="${item.id}">
          <option value="S" ${item.size === "S" ? "selected" : ""}>S</option>
          <option value="M" ${item.size === "M" ? "selected" : ""}>M</option>
          <option value="L" ${item.size === "L" ? "selected" : ""}>L</option>
        </select>
      </td>
      <td>${item.quantity}</td>
      <td>
        <button class="remove-btn" data-id="${item.id}">Xoá</button>
      </td>
    `;
          cartArea.appendChild(cartItem);
          totalPrice += cleanPrice * item.quantity;
        });

        totalPriceEl.textContent = totalPrice.toLocaleString();

        attachRemoveEvent();
      };

      document.addEventListener("change", (event) => {
        if (event.target.classList.contains("cart-size")) {
          const productId = event.target.getAttribute("data-id");
          const newSize = event.target.value;
          updateCartSize(productId, newSize);
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        const checkoutBtn = document.querySelector(".checkout-btn");

        checkoutBtn.addEventListener("click", function () {
          const cartItems = JSON.parse(localStorage.getItem("cart")) || [];

          if (cartItems.length === 0) {
            alert("Giỏ hàng của bạn đang trống!");
            return;
          }

          // Lưu thông tin giỏ hàng vào localStorage trước khi chuyển trang
          localStorage.setItem("checkoutCart", JSON.stringify(cartItems));

          // Chuyển hướng sang trang thanh toán
          window.location.href = "checkout.html";
        });
      });

      function updateCartSize(productId, newSize) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        // Tìm sản phẩm trong giỏ hàng
        const productIndex = cart.findIndex((item) => item.id === productId);
        if (productIndex !== -1) {
          cart[productIndex].size = newSize;
          localStorage.setItem("cart", JSON.stringify(cart));
        }
      }

      function attachRemoveEvent() {
        document.querySelectorAll(".remove-btn").forEach((button) => {
          button.addEventListener("click", (event) => {
            const productId = event.target.dataset.id;
            removeFromCart(productId);
          });
        });
      }

      function removeFromCart(productId) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart = cart.filter((item) => item.id !== productId);
        localStorage.setItem("cart", JSON.stringify(cart));
        window.renderCart();
      }

      // Khi trang giỏ hàng tải, gọi renderCart() để hiển thị danh sách sản phẩm
      document.addEventListener("DOMContentLoaded", window.renderCart);
    </script>
  </body>
</html>
